<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>lib/Clout.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Tutorials</li><li class="nav-item"><a href="tutorial-0-create-project-scaffold.html">0-create-project-scaffold</a></li><li class="nav-item"><a href="tutorial-1-create-api-endpoint.html">1-create-api-endpoint</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-clout-js_lib_Clout-Clout.html">Clout</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-clout-js_lib_Clout-Clout.html#addApi">addApi</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-clout-js_lib_Clout-Clout.html#addModule">addModule</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-clout-js_lib_Clout-Clout.html#loadHooksFromDir">loadHooksFromDir</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-clout-js_lib_Clout-Clout.html#registerHook">registerHook</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-clout-js_lib_Clout-Clout.html#reload">reload</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-clout-js_lib_Clout-Clout.html#start">start</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-clout-js_lib_Clout-Clout.html#stop">stop</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-clout-js_lib_Config-Config.html">Config</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-clout-js_lib_Config-Config.html#loadFromDir">loadFromDir</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-clout-js_lib_Config-Config.html#merge">merge</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-clout-js_lib_Logger-Logger.html">Logger</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-clout-js_lib_Logger-Logger.html#appendToMiddleware">appendToMiddleware</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-clout-js_lib_Logger-Logger.html#logToConsole">logToConsole</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-clout-js_lib_Logger-Logger.html#logToDir">logToDir</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-clout-js_lib_Logger-Logger.html#saveConfiguration">saveConfiguration</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-clout-js_hooks_apis.html">clout-js/hooks/apis</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-clout-js_hooks_config.html">clout-js/hooks/config</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-clout-js_hooks_controllers.html">clout-js/hooks/controllers</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-clout-js_hooks_engines.html">clout-js/hooks/engines</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-clout-js_hooks_middleware.html">clout-js/hooks/middleware</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-clout-js_hooks_models.html">clout-js/hooks/models</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-clout-js_hooks_server.html">clout-js/hooks/server</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-clout-js_lib_Clout.html">clout-js/lib/Clout</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-clout-js_lib_Config.html">clout-js/lib/Config</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-clout-js_lib_Logger.html">clout-js/lib/Logger</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-clout-js_lib_utils.html">clout-js/lib/utils</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-clout-js_test_lib.html">clout-js/test/lib</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-clout-js_test_lib.html#.createhttpUrl">createhttpUrl</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-clout-js_test_lib.html#.createInstance">createInstance</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-clout-js_test_lib.html#.destroyInstance">destroyInstance</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-clout-js_test_lib.html#.request">request</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">lib/Clout.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*!
 * clout-js
 * Copyright(c) 2015 - 2016 Muhammad Dadu
 * MIT Licensed
 */
/**
 * Clout
 * @module clout-js/lib/Clout
 */
const path = require('path');
const fs = require('fs-extra');
const EventEmitter = require('events').EventEmitter;
const util = require('util');

const debug = require('debug')('clout:core');
const async = require('async');
const _ = require('lodash');

const utils = require('./utils');
const Logger = require('./Logger');
const Config = require('./Config');

/**
 * Priority for core hooks
 * @typedef {(number|string)} priority
 * @property {number} CONFIG 5
 * @property {number} MIDDLEWARE 10
 * @property {number} MODEL 15
 * @property {number} API 20
 * @property {number} CONTROLLER 25
 * @const
 */
const CORE_PRIORITY = {
	CONFIG: 5,
	MIDDLEWARE: 10,
	MODEL: 15,
	API: 20,
	CONTROLLER: 25
};

const CLOUT_MODULE_PATH = path.join(__dirname, '..');

/**
 * Clout application
 * @class
 */
class Clout extends EventEmitter {
	/**
	 * @constructor
	 * @param {path} rootDirectory application directory
	 */
	constructor(rootDirectory) {
		super();
		this.handleProcess();

		this.rootDirectory = null;
		this.package = {};
		this.applicationPackage = {};
		this.config = {};
		this.logger = null;
		this.app = null;
		this.server = {};
		this.modules = [];
		this.moduleCache = [];

		// expose core libraries
		this.utils = utils;
		this.async = async;
		this._ = _;
		this.fs = fs;

		// allow application hooks (Synchronous)
		this.CORE_PRIORITY = CORE_PRIORITY;
		this.hooks = {
			start: [],
			stop: [],
			reload: []
		};

		// Load clout configuration
		this.config = new Config();
		this.config.loadFromDir(path.join(__dirname, '../resources/conf'));

		this.applicationPackage = {};

		// load clout package.json
		this.package = require(path.join(__dirname, '../package.json'));

		// load clout modules
		if (this.package.modules) {
			this.addModules(this.package.modules);
		}

		if (rootDirectory) {
			// set application root directory
			this.rootDirectory = path.resolve(rootDirectory);

			// load application manifest
			['package.json', 'clout.json'].forEach((fileName) => {
				let filePath = path.resolve(this.rootDirectory, fileName);
				if (!fs.existsSync(filePath)) {
					return debug(`${fileName} not found`);
				}

				_.merge(this.applicationPackage, require(filePath));
			});

			process.title = `[clout-js v${this.package.version}] ${this.applicationPackage.name}`;

			// add rootdir to node_modules
			module.paths.unshift(path.join(this.rootDirectory, 'node_modules'));

			// load modules from application manifest
			if (this.applicationPackage.modules) {
				this.addModules(this.applicationPackage.modules);
			}
		}

		// append module configuration
		this.modules.forEach((module) => this.config.loadFromDir(path.join(module.path, 'conf')));

		// append application configuration (Overrides module conf)
		this.config.loadFromDir(path.join(this.rootDirectory, 'conf'));

		// initialize logger
		this.logger = new Logger(this);

		// 1) load core hooks
		// 2) load application hooks
		// 3) load module hooks
		this.loadHooksFromDir(CLOUT_MODULE_PATH)
			.then(this.loadHooksFromDir(this.rootDirectory))
			.then(() => new Promise((resolve, reject) => {
				async.each(this.modules, (module, next) => {
					this.loadHooksFromDir(module.path)
						.then(() => next())
						.catch((err) => {
							console.error(err);
							next()
						});
				}, (err) => {
					if (err) { return reject(err); }
					resolve();
				});

				this.initialized = true;
			}))
			.catch((err) => console.error(err));
	}

	/**
	 * hook into clout runtime
	 * @param {string}   	event 		event name
	 * @param {Function} 	fn    		function to execute
	 * @param {String} 		fn._name    	hook name
	 * @param {String} 		fn.group    hook group
	 * @param {Number}		priority	function priority
	 * @param {Boolean}		override	override existing
	 * @example
	 * // register a function to the hook
	 * clout.registerHook('start', function (next) {
	 * 	next();
	 * });
	 * // invoking an error in clout runtime
	 * clout.registerHook('start', function (next) {
	 * 	next(new Error('Error executing function'));
	 * });
	 */
	registerHook(event, fn, priority, override) {
		debug('registerHook:event=%s:fn:priority=%s', event, priority);

		if (!this.hooks.hasOwnProperty(event)) {
			throw new Error('Invalid Hook Event');
		}

		typeof priority !== 'undefined' &amp;&amp; (fn.priority = priority);

		// find existing, override
		if (override === true) {
			debug('override');
			for (var i = 0, l = this.hooks[event].length; i &lt; l; ++i) {
				var hook = this.hooks[event][i];
				if (hook._name !== null &amp;&amp; hook._name === fn._name &amp;&amp; hook.group === fn.group) {
					debug('match found, overriden');
					this.hooks[event][i] = fn;
					return;
				}
			}
		}

		// push is no priority
		if (!fn.priority) {
			debug('push hook (no priority)');
			return this.hooks[event].push(fn);
		}

		// find the correct place to register hook
		for (var i = 0, l = this.hooks[event].length; i &lt; l; ++i) {
			var tmp_p = this.hooks[event][i].priority || 99999;
			if (fn.priority &lt; tmp_p) {
				debug('push hook at index %s', String(i));
				return this.hooks[event].splice(i, 0, fn);
			}
		}

		debug('push hook (lowest priority yet)');
		return this.hooks[event].push(fn);
	}

	/**
	 * Loads hooks from directory
	 * @param  {Path} dir directory
	 * @return {Promise}  promise 
	 */
	loadHooksFromDir(dir) {
		var glob = path.join(dir, '/hooks/**/*.js'),
			files = utils.getGlobbedFiles(glob);

		debug('loadHooksFromDir: %s', dir);

		return new Promise((resolve, reject) => {
			async.each(files, (file, next) => {
				debug('loading hooks from file: %s', String(file));

				let hooks = require(file);
				let keys = Object.keys(hooks);

				keys.forEach((key) => {
					let hook = hooks[key];
					let args = [];

					debug('Loading hook: %s', key);

					// create args
					if (!hook.event || !hook.fn) {
						throw new Error('Hook missing attributes');
					}
					hook.fn.group = file.split('hooks/')[1].replace('.js', '');
					hook.fn._name = key;
					args.push(hook.event);
					args.push(hook.fn);
					if (typeof hook.priority !== 'undefined') {
						if (typeof hook.priority === 'string') {
							if (!this.CORE_PRIORITY.hasOwnProperty(hook.priority)) {
								throw "Invalid priority type";
							}
							hook.priority = this.CORE_PRIORITY[hook.priority];
						}
						args.push(hook.priority);
					} else {
						args.push(null);
					}
					if (hook.override) {
						args.push(true);
					}
					this.registerHook.apply(this, args);
				});
				next();
			}, function done(err) {
				if (err) {
					debug(err);
					return reject(err);
				}
				debug('all hooks loaded from %s', dir);
				resolve();
			});
		});
	}

	addModules(modules) {
		debug('loading modules', JSON.stringify(modules));
		modules.forEach((moduleName) => this.addModule(moduleName));
	}

	/**
	 * Load clout-js node module
	 * @param {string} moduleName clout node module name
	 */
	addModule(moduleName) {
		if (!!~this.moduleCache.indexOf(moduleName)) {
			debug('module: %s already loaded', moduleName);
			return;
		}

		debug('loading module: %s', moduleName);
		this.moduleCache.push(moduleName);

		let cloutModule = {
			name: moduleName,
			path: path.dirname(require.resolve(moduleName)),
			manifest: {}
		};

		this.modules.push(cloutModule);
		debug(cloutModule);

		// load module manifest
		['package.json', 'clout.json'].forEach((fileName) => {
			let filePath = path.resolve(cloutModule.path, fileName);
			if (!fs.existsSync(filePath)) {
				return debug(`${fileName} not found`);
			}

			_.merge(cloutModule.manifest, require(filePath));
		});

		// load module modules
		if (cloutModule.manifest.modules) {
			debug('%s loading modules %s', moduleName, manifest.modules);
			this.addModules(manifest.modules);
		}
	}

	/**
	 * Start clout
	 * @return {Promise} returns a promise
	 */
	start() {
		this.emit('initialized');

		if (!this.initialized) {
			return new Promise((resolve) => {
				setTimeout(() => resolve(this.start()), 100);
			});
		}

		this.emit('start');

		return new Promise((resolve, reject) => {
			process.nextTick(() => {
				async.eachLimit(this.hooks.start, 1, (hook, next) => {
					debug('executing', hook.name || hook._name, hook.group);
					let hookResponse = hook.apply(this, [next]);

					// support promises
					if (typeof hookResponse === 'object') {
						hookResponse.then(next, (err) => next(null, err));
					}
				}, (err) => {
					if (err) {
						debug(err);
						return reject(err);
					}
					resolve();
					this.emit('started');
				});
			});
		});
	}

	// TODO:- investigate if we still need this?
	/**
	 * Add API
	 * @param {string} path api path
	 * @param {function} fn express function
	 */
	addApi(path, fn) {
		this.app.use(path, function (req, resp, next) {
			let promiseResponse = fn.apply(this, arguments);

			// support for prmises
			// bind to app.use
			if (String(promiseResponse) === '[object Promise]') {
				promiseResponse
					.then((payload) => {
						switch (Object.prototype.toString.call(payload)) {
							case '[object Object]':
							case '[object String]':
								resp.success(payload);
								break;
							case '[object Undefined]':
								break;
							default:
								console.error('type not supported');
								resp.error('response type is invalid');
								break;
						}
						next();
					})
					.catch((payload) => {
						switch (Object.prototype.toString.call(payload)) {
							case '[object Object]':
							case '[object String]':
								resp.error(payload);
								break;
							case '[object Undefined]':
								break;
							default:
								console.error('type not supported');
								resp.error('response type is invalid');
								break;
						}
						next();
					});
			}
		});

		return new Promise.resolve();
	}

	/**
	 * Stop clout
	 * @return {Promise} returns a promise
	 */
	stop() {
		this.emit('stop');
		return new Promise((resolve, reject) => {
			async.eachLimit(this.hooks.stop, 1, (hook, next) => {
				hook.apply(this, [next]);
			}, (err) => {
				if (err) {
					debug(err);
					return reject(err);
				}

				resolve();
				this.emit('stopped');
			});
		});
	}

	/**
	 * Reload clout
	 * @return {Promise} returns a promise
	 */
	reload() {
		this.emit('reload');

		return this.stop()
			.then(this.start)
			.then(() => {
				deferred.resolve();
				this.emit('reloaded');
			});
	}

	handleProcess() {
		process.on('unhandledRejection', (err) => {
			console.error(err);
		});

		process.on('uncaughtException', (err) => {
			console.log(err);
			process.exit(0);
		});
	}
}

module.exports = Clout;
module.exports.PRIORITY = CORE_PRIORITY;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Feb 27 2018 23:53:52 GMT+0000 (GMT) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
